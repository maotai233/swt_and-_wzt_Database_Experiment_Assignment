<!DOCTYPE html>
<html data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>添加读者 - 图书管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/daisyui/4.12.10/full.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
  <!-- 导航栏 -->
  <div class="navbar" style="background-color:#7F5FCE; color:white;">
    <div class="flex-1">
      <a href="/admin/dashboard" class="btn btn-ghost normal-case text-xl">
        <i class="fas fa-book mr-2"></i>图书管理系统 - 管理员
      </a>
    </div>
    <div class="flex-none">
      <ul class="menu menu-horizontal px-1">
        <li class="mr-4"> <a href="/admin/dashboard" class="btn border-none" style="background-color: #d4c4e7; ">返回管理员面板</a></li>
        <li class="mr-4"><a href="/admin/readers" class="btn border-none" style="background-color: #d4c4e7; ">返回读者列表</a></li>
        <li><a href="/logout" class="btn btn-error">退出登录</a></li>
      </ul>
    </div>
  </div>

    <div class="container mx-auto px-4 py-8">
        <div class="max-w-2xl mx-auto">
            <div class="card bg-white shadow-lg">
                <div class="card-body">
                    <h1 class="text-2xl font-bold text-gray-800 mb-6">
                        <i class="fas fa-user-plus text-blue-600 mr-2"></i>添加新读者
                    </h1>
                    
                    <!-- 结果显示区域 -->
                    <div id="resultMessage" class="mb-4"></div>
                    
                    <!-- 读者添加表单 -->
                    <form id="addReaderForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- 读者姓名 -->
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">读者姓名 *</span>
                                </label>
                                <input type="text" id="reader_name" name="reader_name" placeholder="请输入读者姓名" class="input input-bordered" required>
                                <label class="label">
                                    <span class="label-text-alt text-gray-500">例如：张三</span>
                                </label>
                            </div>
                            
                            <!-- 性别 -->
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">性别 *</span>
                                </label>
                                <select id="sex" name="sex" class="select select-bordered" required>
                                    <option value="">请选择性别</option>
                                    <option value="男">男</option>
                                    <option value="女">女</option>
                                </select>
                            </div>
                            
                            <!-- 身份证号 -->
                            <div class="form-control md:col-span-2">
                                <label class="label">
                                    <span class="label-text">身份证号 *</span>
                                </label>
                                <input type="text" id="id_number" name="id_number" placeholder="请输入18位身份证号" class="input input-bordered" 
                                       pattern="\d{17}[\dXx]" maxlength="18" required>
                                <label class="label">
                                    <span class="label-text-alt text-gray-500">请正确填写18位身份证号</span>
                                </label>
                            </div>
                            
                            <!-- 登录用户名 -->
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">登录用户名 *</span>
                                </label>
                                <input type="text" id="username" name="username" placeholder="请输入登录用户名" class="input input-bordered" required>
                                <label class="label">
                                    <span class="label-text-alt text-gray-500">用于登录系统</span>
                                </label>
                            </div>
                            
                            <!-- 登录密码 -->
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">登录密码 *</span>
                                </label>
                                <input type="password" id="password" name="password" placeholder="请输入登录密码" class="input input-bordered" 
                                       minlength="6" required>
                                <label class="label">
                                    <span class="label-text-alt text-gray-500">密码长度至少6位</span>
                                </label>
                            </div>
                            
                            <!-- 确认密码 -->
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">确认密码 *</span>
                                </label>
                                <input type="password" id="confirm_password" placeholder="请再次输入密码" class="input input-bordered" required>
                                <label class="label">
                                    <span class="label-text-alt text-gray-500">请确保两次输入的密码一致</span>
                                </label>
                            </div>
                            
                            <!-- 联系电话 -->
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">联系电话</span>
                                </label>
                                <input type="tel" id="phone" name="phone" placeholder="请输入联系电话" class="input input-bordered">
                            </div>
                            
                            <!-- 可借册数 -->
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">可借册数 *</span>
                                </label>
                                <input type="number" id="borrowable_books" name="borrowable_books" value="5" min="1" max="20" class="input input-bordered" required>
                                <label class="label">
                                    <span class="label-text-alt text-gray-500">默认为5本，范围1-20本</span>
                                </label>
                            </div>
                            
                            <!-- 借期天数 -->
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">借期天数 *</span>
                                </label>
                                <input type="number" id="borrow_days" name="borrow_days" value="30" min="7" max="90" class="input input-bordered" required>
                                <label class="label">
                                    <span class="label-text-alt text-gray-500">默认为30天，范围7-90天</span>
                                </label>
                            </div>
                            
                            <!-- 联系地址 -->
                            <div class="form-control md:col-span-2">
                                <label class="label">
                                    <span class="label-text">联系地址</span>
                                </label>
                                <input type="text" id="address" name="address" placeholder="请输入联系地址" class="input input-bordered">
                            </div>
                        </div>
                        
                        <!-- 备注信息 -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">备注</span>
                            </label>
                            <textarea id="remark" name="remark" placeholder="请输入备注信息（选填）" class="textarea textarea-bordered" rows="2"></textarea>
                        </div>
                        
                        <!-- 提交按钮 -->
                        <div class="form-control mt-6">
                            <button type="submit" id="submitBtn" class="btn btn-primary">
                                <i class="fas fa-save mr-2"></i>添加读者
                            </button>
                        </div>
                    </form>
                    
                    <div class="divider">或</div>
                    
                    <div class="text-center">
                        <a href="/admin/readers" class="btn btn-ghost">
                            <i class="fas fa-arrow-left mr-2"></i>返回读者列表
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 表单提交处理
        document.getElementById('addReaderForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // 禁用提交按钮，防止重复提交
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>添加中...';
            
            // 获取表单数据

            const formData = {
                reader_name: document.getElementById('reader_name').value.trim(),
                sex: document.getElementById('sex').value.trim(),
                id_number: document.getElementById('id_number').value.trim(),
                username: document.getElementById('username').value.trim(),
                password: document.getElementById('password').value,
                phone: document.getElementById('phone').value.trim() || '',
                borrowable_books: parseInt(document.getElementById('borrowable_books').value),
                borrow_days: parseInt(document.getElementById('borrow_days').value),
                address: document.getElementById('address').value.trim() || '',
                remark: document.getElementById('remark').value.trim() || ''
            };
            
            // 验证必填字段
            const requiredFields = ['reader_name', 'sex', 'id_number', 'username', 'password'];
            for (const field of requiredFields) {
                if (!formData[field]) {
                    showMessage(`请填写"${getFieldLabel(field)}"字段！`, 'error');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>添加读者';
                    return;
                }
            }
            
            // 验证密码长度
            if (formData.password.length < 6) {
                showMessage('密码长度至少6位！', 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>添加读者';
                return;
            }
            
            // 验证密码一致性
            const confirmPassword = document.getElementById('confirm_password').value;
            if (formData.password !== confirmPassword) {
                showMessage('两次输入的密码不一致！', 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>添加读者';
                return;
            }
            
            // 验证身份证号格式
            const idCardPattern = /^\d{17}[\dXx]$/;
            if (!idCardPattern.test(formData.id_number)) {
                showMessage('请输入有效的18位身份证号！', 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>添加读者';
                return;
            }
            
            // 验证可借册数范围
            if (formData.borrowable_books < 1 || formData.borrowable_books > 20) {
                showMessage('可借册数应在1-20本之间！', 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>添加读者';
                return;
            }
            
            // 验证借期天数范围
            if (formData.borrow_days < 7 || formData.borrow_days > 90) {
                showMessage('借期天数应在7-90天之间！', 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>添加读者';
                return;
            }
            
            // 显示加载状态
            showMessage('正在提交数据，请稍候...', 'info');
            
            try {
                // 发送POST请求到API
                const response = await fetch('/api/readers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 显示成功消息
                    showMessage(`
                        <div class="space-y-2">
                            <p><strong>读者添加成功！</strong></p>
                            <p>读者编号：<span class="font-bold">${data.reader_number}</span></p>
                            <p>借阅卡号：<span class="font-bold">${data.card_number}</span></p>
                            <p>读者姓名：<span class="font-bold">${data.reader_name}</span></p>
                            <p>登录用户名：<span class="font-bold">${formData.username}</span></p>
                            <p class="text-sm text-gray-600 mt-4">3秒后自动跳转回读者列表...</p>
                        </div>
                    `, 'success');
                    
                    // 清除表单
                    document.getElementById('addReaderForm').reset();
                    
                    // 3秒后跳转回读者列表
                    setTimeout(() => {
                        window.location.href = '/admin/readers';
                    }, 3000);
                } else {
                    // 显示错误消息
                    showMessage(`添加失败：${data.message}`, 'error');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>添加读者';
                }
            } catch (error) {
                console.error('添加读者出错:', error);
                showMessage(`网络错误：${error.message}，请稍后重试`, 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>添加读者';
            }
        });
        
        // 显示消息的函数
        function showMessage(message, type) {
            const resultDiv = document.getElementById('resultMessage');
            const typeClass = {
                'success': 'alert-success',
                'error': 'alert-error',
                'info': 'alert-info',
                'warning': 'alert-warning'
            }[type];
            
            const iconClass = {
                'success': 'fa-check-circle',
                'error': 'fa-exclamation-circle',
                'info': 'fa-info-circle',
                'warning': 'fa-exclamation-triangle'
            }[type];
            
            resultDiv.innerHTML = `
                <div class="alert ${typeClass}">
                    <i class="fas ${iconClass}"></i>
                    <div class="flex-1">${message}</div>
                </div>
            `;
        }
        
        // 获取字段标签
        function getFieldLabel(fieldName) {
            const labels = {
                'reader_name': '读者姓名',
                'sex': '性别',
                'id_number': '身份证号',
                'username': '登录用户名',
                'password': '登录密码'
            };
            return labels[fieldName] || fieldName;
        }
        
        // 身份证号输入时自动格式化
        document.getElementById('id_number').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^\dXx]/g, '').toUpperCase();
            if (value.length > 18) {
                value = value.substring(0, 18);
            }
            e.target.value = value;
        });
        
        // 联系电话输入验证
        document.getElementById('phone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^\d]/g, '');
            if (value.length > 11) {
                value = value.substring(0, 11);
            }
            e.target.value = value;
        });
        
        // 密码一致性实时验证
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirm_password');
        
        function validatePasswords() {
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            
            if (confirmPassword && password !== confirmPassword) {
                confirmPasswordInput.classList.add('input-error');
            } else {
                confirmPasswordInput.classList.remove('input-error');
            }
        }
        
        passwordInput.addEventListener('input', validatePasswords);
        confirmPasswordInput.addEventListener('input', validatePasswords);
    </script>
</body>
</html>