<!DOCTYPE html>
<html data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>读者管理 - 图书管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/daisyui/4.12.10/full.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
  <!-- 导航栏 -->
  <div class="navbar" style="background-color:#7F5FCE; color:white;">
    <div class="flex-1">
      <a href="/admin/dashboard" class="btn btn-ghost normal-case text-xl">
        <i class="fas fa-book mr-2"></i>图书管理系统 - 管理员
      </a>
    </div>
    <div class="flex-none">
      <ul class="menu menu-horizontal px-1">
        <li class="mr-4"> <a href="/admin/dashboard" class="btn border-none" style="background-color: #d4c4e7; ">返回管理员面板</a></li>
        <li><a href="/logout" class="btn btn-error">退出登录</a></li>
      </ul>
    </div>
  </div>

    <div class="container mx-auto px-4 py-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">
                <i class="fas fa-exclamation-triangle text-red-600 mr-3"></i>报损管理
            </h1>
            <p class="text-gray-600 mt-2">管理图书报损和损坏记录</p>
        </div>

        <!-- 新增报损记录 -->
        <div class="card bg-white shadow-lg mb-8">
            <div class="card-body">
                <h2 class="card-title text-red-600 mb-4">
                    <i class="fas fa-plus mr-2"></i>新增报损记录
                </h2>
                
                <!-- 消息提示 -->
                <div id="message" class="mb-4"></div>
                
                <form id="damageForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">报损单号 *</span>
                            </label>
                            <input type="text" id="damage_no" class="input input-bordered" 
                                   placeholder="如：BD202312001" required>
                            <label class="label">
                                <span class="label-text-alt text-gray-500">建议格式：BD+年月+序号</span>
                            </label>
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">报损日期 *</span>
                            </label>
                            <input type="date" id="damage_date" class="input input-bordered" required>
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">图书编号 *</span>
                            </label>
                            <input type="text" id="book_no" class="input input-bordered" 
                                   placeholder="输入图书编号" required>
                            <button type="button" onclick="searchBook()" class="btn btn-sm btn-ghost mt-1">
                                <i class="fas fa-search mr-1"></i>查找图书
                            </button>
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">报损数量 *</span>
                            </label>
                            <input type="number" id="damage_num" class="input input-bordered" 
                                   min="1" max="100" value="1" required>
                            <label class="label">
                                <span class="label-text-alt text-gray-500">范围：1-100本</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">损坏原因 *</span>
                        </label>
                        <select id="damage_reason" class="select select-bordered" required>
                            <option value="">请选择损坏原因</option>
                            <option value="自然损坏">自然损坏</option>
                            <option value="人为损坏">人为损坏</option>
                            <option value="遗失">遗失</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">备注说明</span>
                        </label>
                        <textarea id="damage_remark" class="textarea textarea-bordered" 
                                  placeholder="可填写详细的损坏情况说明..." rows="2"></textarea>
                    </div>
                    
                    <div class="form-control mt-6">
                        <button type="submit" id="submitBtn" class="btn btn-primary border-none" style="background-color: #b73434; color: rgb(255, 255, 255);">
                            <i class="fas fa-save mr-2"></i>保存报损记录
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 报损记录列表 -->
        <div class="card bg-white shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-red-600 mb-4">
                    <i class="fas fa-list mr-2"></i>报损记录
                </h2>
                
                <!-- 搜索和筛选 -->
                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <div class="flex-1">
                        <input type="text" id="searchInput" placeholder="搜索报损单号、图书名称、原因..." 
                               class="input input-bordered w-full">
                    </div>
                    <button onclick="searchDamages()" class="btn btn-primary border-none" style="background-color: #b73434; color: rgb(255, 255, 255);">
                        <i class="fas fa-search mr-2"></i>搜索
                    </button>
                    <button onclick="refreshDamages()" class="btn btn-ghost">
                        <i class="fas fa-redo mr-2"></i>刷新
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="table table-zebra w-full">
                        <thead>
                            <tr class="bg-red-50">
                                <th>报损单号</th>
                                <th>报损日期</th>
                                <th>图书编号</th>
                                <th>书名</th>
                                <th>损坏原因</th>
                                <th>报损数量</th>
                                <th>经手人</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="damageList">
                            {% for damage in damages %}
                            <tr>
                                <td>{{ damage[0] }}</td>
                                <td>{{ damage[2] }}</td>
                                <td>{{ damage[5] }}</td>
                                <td>{{ damage[6] }}</td>
                                <td>{{ damage[7] }}</td>
                                <td>{{ damage[8] }}</td>
                                <td>{{ damage[4] }}</td>
                                <td>
                                    <button onclick="deleteDamage('{{ damage[0] }}')" class="btn btn-sm btn-error">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- 如果没有数据 -->
                {% if not damages %}
                <div class="text-center py-8">
                    <p class="text-gray-500">暂无报损记录</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 图书搜索模态框 -->
    <dialog id="bookSearchModal" class="modal">
        <form method="dialog" class="modal-box max-w-3xl">
            <h3 class="font-bold text-lg mb-4">
                <i class="fas fa-search mr-2"></i>查找图书
            </h3>
            
            <div class="mb-4">
                <div class="flex gap-2">
                    <input type="text" id="bookSearchInput" placeholder="输入图书编号或名称..." 
                           class="input input-bordered flex-1">
                    <button type="button" onclick="performBookSearch()" class="btn btn-primary border-none" style="background-color: oklch; color:white;">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto max-h-96">
                <table class="table table-zebra w-full">
                    <thead>
                        <tr>
                            <th>图书编号</th>
                            <th>书名</th>
                            <th>作者</th>
                            <th>现存量</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="bookSearchResults">
                        <!-- 搜索结果将在这里显示 -->
                    </tbody>
                </table>
            </div>
            
            <div class="modal-action">
                <button class="btn">取消</button>
            </div>
        </form>
    </dialog>

    <script>
        // 页面加载时设置默认日期为今天
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('damage_date').value = today;
            
            // 生成报损单号
            generateDamageNo();
        });
        
        // 显示消息
        function showMessage(message, type = 'info') {
            const messageDiv = document.getElementById('message');
            const alertClasses = {
                'success': 'alert-success',
                'error': 'alert-error',
                'info': 'alert-info',
                'warning': 'alert-warning'
            };
            
            const iconClasses = {
                'success': 'fa-check-circle',
                'error': 'fa-exclamation-circle',
                'info': 'fa-info-circle',
                'warning': 'fa-exclamation-triangle'
            };
            
            messageDiv.innerHTML = `
                <div class="alert ${alertClasses[type]}">
                    <i class="fas ${iconClasses[type]}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            // 3秒后自动清除消息
            if (type !== 'error') {
                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 3000);
            }
        }
        
        // 生成报损单号
        function generateDamageNo() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            
            const damageNo = `BD${year}${month}${day}${random}`;
            document.getElementById('damage_no').value = damageNo;
        }
        
        // 报损表单提交
        document.getElementById('damageForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // 获取表单数据
            const damageData = {
                damage_no: document.getElementById('damage_no').value.trim(),
                damage_date: document.getElementById('damage_date').value,
                book_no: document.getElementById('book_no').value.trim(),
                damage_num: parseInt(document.getElementById('damage_num').value),
                damage_reason: document.getElementById('damage_reason').value,
                damage_remark: document.getElementById('damage_remark').value.trim()
            };
            
            // 验证数据
            if (!damageData.damage_no) {
                showMessage('请输入报损单号', 'error');
                return;
            }
            
            if (!damageData.damage_date) {
                showMessage('请选择报损日期', 'error');
                return;
            }
            
            if (!damageData.book_no) {
                showMessage('请输入图书编号', 'error');
                return;
            }
            
            if (damageData.damage_num <= 0) {
                showMessage('报损数量必须大于0', 'error');
                return;
            }
            
            if (!damageData.damage_reason) {
                showMessage('请选择损坏原因', 'error');
                return;
            }
            
            // 禁用提交按钮，防止重复提交
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>处理中...';
            
            try {
                // 发送请求
                const response = await fetch('/api/damage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(damageData)
                });
                
                // 检查响应类型
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('非JSON响应:', text.substring(0, 200));
                    throw new Error('服务器返回了非JSON格式的响应');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    
                    // 清空表单
                    document.getElementById('damageForm').reset();
                    
                    // 设置默认日期
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('damage_date').value = today;
                    
                    // 生成新的报损单号
                    generateDamageNo();
                    
                    // 刷新报损记录列表
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showMessage('报损失败：' + data.message, 'error');
                }
            } catch (error) {
                console.error('报损出错:', error);
                showMessage('报损失败：' + error.message, 'error');
            } finally {
                // 恢复提交按钮
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>保存报损记录';
            }
        });
        
        // 搜索图书
        function searchBook() {
            document.getElementById('bookSearchModal').showModal();
        }
        
        // 执行图书搜索
        async function performBookSearch() {
            const searchValue = document.getElementById('bookSearchInput').value.trim();
            
            if (!searchValue) {
                alert('请输入搜索关键词');
                return;
            }
            
            try {
                const response = await fetch(`/api/books/search?q=${encodeURIComponent(searchValue)}`);
                const data = await response.json();
                
                const tbody = document.getElementById('bookSearchResults');
                
                if (data.success && data.books && data.books.length > 0) {
                    let html = '';
                    data.books.forEach(book => {
                        html += `
                            <tr>
                                <td>${book.BNo}</td>
                                <td>${book.BName}</td>
                                <td>${book.BAuthor}</td>
                                <td>${book.Biomass}</td>
                                <td>
                                    <button onclick="selectBook('${book.BNo}')" class="btn btn-sm btn-primary">
                                        选择
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    tbody.innerHTML = html;
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center py-4">
                                <p class="text-gray-500">未找到相关图书</p>
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('搜索图书出错:', error);
                alert('搜索失败：' + error.message);
            }
        }
        
        // 选择图书
        function selectBook(bookNo) {
            document.getElementById('book_no').value = bookNo;
            document.getElementById('bookSearchModal').close();
        }
        
        // 搜索报损记录
        function searchDamages() {
            const searchValue = document.getElementById('searchInput').value.trim().toLowerCase();
            const rows = document.querySelectorAll('#damageList tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchValue)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // 刷新报损记录
        function refreshDamages() {
            location.reload();
        }
        
        // 删除报损记录
        function deleteDamage(damageNo) {
            if (confirm(`确定要删除报损单 ${damageNo} 吗？此操作不可撤销。`)) {
                fetch(`/api/damage/${damageNo}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('删除成功');
                        location.reload();
                    } else {
                        alert('删除失败：' + data.message);
                    }
                })
                .catch(error => {
                    alert('删除失败：' + error.message);
                });
            }
        }
        
        // 按回车搜索
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchDamages();
            }
        });
    </script>
</body>
</html>