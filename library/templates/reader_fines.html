<!DOCTYPE html>
<html data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图书管理 - 图书管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/daisyui/4.12.10/full.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <!-- 导航栏 -->
    <div class="navbar" style="background-color:#2563eb; color:white;">
        <div class="flex-1">
            <a href="/admin/dashboard" class="btn btn-ghost normal-case text-xl">
                <i class="fas fa-book mr-2"></i>图书管理系统 - 读者
            </a>
        </div>
        <div class="flex-none">
            <ul class="menu menu-horizontal px-1">
                <li class="mr-4">
                    <a href="/reader/dashboard" class="btn border-none" style="background-color: #d4c4e7; ">返回读者面板</a></li>
                </li>
                <li><a href="/logout" class="btn btn-error">退出登录</a></li>
            </ul>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">
                <i class="fas fa-money-bill-wave text-green-600 mr-3"></i>罚款缴费
            </h1>
            <p class="text-gray-600 mt-2">查看和管理您的罚款记录</p>
        </div>

        <!-- 罚款统计 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" id="stats-container">
            <!-- 动态加载统计信息 -->
        </div>

        <!-- 缴费表单 -->
        <div class="card bg-white shadow-lg mb-8">
            <div class="card-body">
                <h2 class="card-title text-gray-700 mb-4">
                    <i class="fas fa-credit-card mr-2"></i>缴纳罚款
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <select id="fine-select" class="select select-bordered">
                        <option value="">选择要缴纳的罚款单</option>
                        <!-- 动态加载 -->
                    </select>
                    <div>
                        <input type="number" id="payment-amount" placeholder="输入缴费金额" 
                               class="input input-bordered w-full" min="0" step="1">
                    </div>
                    <button onclick="payFine()" class="btn btn-primary border-none" style="background-color: oklch; color: rgb(255, 255, 255);">
                        <i class="fas fa-check-circle mr-2"></i>确认缴费
                    </button>
                </div>
                <div class="mt-4">
                    <p class="text-sm text-gray-500">提示：您可以选择部分缴纳或全额缴纳</p>
                </div>
            </div>
        </div>

        <!-- 罚款记录列表 -->
        <div class="card bg-white shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-gray-700 mb-4">
                    <i class="fas fa-history mr-2"></i>罚款记录
                </h2>
                <div class="overflow-x-auto">
                    <table class="table table-zebra w-full">
                        <thead>
                            <tr class="bg-green-50">
                                <th>罚款单号</th>
                                <th>日期</th>
                                <th>相关图书</th>
                                <th>罚款金额</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="fines-table-body">
                            <!-- 动态加载 -->
                        </tbody>
                    </table>
                </div>
                
                <div class="alert alert-info mt-6" id="no-data-alert" style="display: none;">
                    <div>
                        <i class="fas fa-info-circle"></i>
                        <span>暂无罚款记录</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 页面加载时获取罚款记录
        document.addEventListener('DOMContentLoaded', function() {
            loadFines();
        });
        
        // 加载罚款记录
        function loadFines() {
            fetch('/api/reader/fines')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayStats(data.stats);
                        displayFines(data.fines);
                        populateFineSelect(data.fines);
                    } else {
                        alert('获取罚款记录失败：' + data.message);
                    }
                })
                .catch(error => {
                    console.error('获取罚款记录出错:', error);
                    alert('获取罚款记录出错，请稍后重试');
                });
        }
        
        // 显示统计信息
        function displayStats(stats) {
            const statsContainer = document.getElementById('stats-container');
            
            const statsHTML = `
                <div class="card bg-white shadow-lg">
                    <div class="card-body">
                        <h2 class="text-2xl font-bold text-blue-600">${stats.total_fines}</h2>
                        <p class="text-gray-600">总罚款单数</p>
                    </div>
                </div>
                <div class="card bg-white shadow-lg">
                    <div class="card-body">
                        <h2 class="text-2xl font-bold text-red-600">¥${stats.unpaid_amount.toFixed(2)}</h2>
                        <p class="text-gray-600">待缴金额</p>
                    </div>
                </div>
                <div class="card bg-white shadow-lg">
                    <div class="card-body">
                        <h2 class="text-2xl font-bold text-orange-600">${stats.unpaid_count}</h2>
                        <p class="text-gray-600">未缴单数</p>
                    </div>
                </div>
                <div class="card bg-white shadow-lg">
                    <div class="card-body">
                        <h2 class="text-2xl font-bold text-green-600">${stats.paid_count}</h2>
                        <p class="text-gray-600">已缴单数</p>
                    </div>
                </div>
            `;
            
            statsContainer.innerHTML = statsHTML;
        }
        
        // 显示罚款记录
        function displayFines(fines) {
            const tbody = document.getElementById('fines-table-body');
            const noDataAlert = document.getElementById('no-data-alert');
            
            if (fines.length === 0) {
                tbody.innerHTML = '';
                noDataAlert.style.display = 'flex';
                return;
            }
            
            noDataAlert.style.display = 'none';
            
            let tbodyHTML = '';
            fines.forEach(fine => {
                // 状态标签
                let statusBadge = '';
                if (fine.is_paid) {
                    statusBadge = '<span class="badge badge-success">已缴清</span>';
                } else {
                    statusBadge = '<span class="badge badge-error">未缴纳</span>';
                }
                
                // 操作按钮
                let actionButton = '';
                if (!fine.is_paid) {
                    actionButton = `
                        <button onclick="selectFine('${fine.fine_number}', ${fine.amount})" 
                                class="btn btn-xs btn-primary">
                            缴纳
                        </button>
                    `;
                } else {
                    actionButton = '<span class="text-gray-400">已处理</span>';
                }
                
                const row = `
                    <tr>
                        <td>${fine.fine_number}</td>
                        <td>${fine.fine_date}</td>
                        <td>${fine.book_name || '--'}</td>
                        <td class="font-bold ${fine.is_paid ? 'text-green-600' : 'text-red-600'}">
                            ¥${fine.amount.toFixed(2)}
                        </td>
                        <td>${statusBadge}</td>
                        <td>${actionButton}</td>
                    </tr>
                `;
                tbodyHTML += row;
            });
            
            tbody.innerHTML = tbodyHTML;
        }
        
        // 填充罚款选择下拉框
        function populateFineSelect(fines) {
            const select = document.getElementById('fine-select');
            select.innerHTML = '<option value="">选择要缴纳的罚款单</option>';
            
            fines.forEach(fine => {
                if (!fine.is_paid && fine.amount > 0) {
                    const option = document.createElement('option');
                    option.value = fine.fine_number;
                    option.textContent = `${fine.fine_number} - ¥${fine.amount.toFixed(2)} - ${fine.book_name || '罚款'}`;
                    option.setAttribute('data-amount', fine.amount);
                    select.appendChild(option);
                }
            });
        }
        
        // 选择罚款单
        function selectFine(fineNumber, amount) {
            document.getElementById('fine-select').value = fineNumber;
            document.getElementById('payment-amount').value = amount.toFixed(2);
            document.getElementById('payment-amount').focus();
        }
        
        // 缴纳罚款
        function payFine() {
            const fineNumber = document.getElementById('fine-select').value;
            const paymentAmount = parseFloat(document.getElementById('payment-amount').value);
            
            if (!fineNumber) {
                alert('请选择要缴纳的罚款单');
                return;
            }
            
            if (!paymentAmount || paymentAmount <= 0) {
                alert('请输入有效的缴费金额');
                return;
            }
            
            if (!confirm(`确认缴纳 ¥${paymentAmount.toFixed(2)} 的罚款吗？`)) {
                return;
            }
            
            fetch('/api/reader/fines/pay', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    fine_number: fineNumber,
                    payment_amount: paymentAmount
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    loadFines(); // 重新加载数据
                    // 清空表单
                    document.getElementById('payment-amount').value = '';
                } else {
                    alert('缴费失败：' + data.message);
                }
            })
            .catch(error => {
                console.error('缴费出错:', error);
                alert('缴费出错，请稍后重试');
            });
        }
    </script>
</body>
</html>